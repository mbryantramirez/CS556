
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="robots" content="index,nofollow">
    <title>POSIX Permissions and Stateful Firewalls</title>
    <link rel="stylesheet" type="text/css" charset="utf-8" media="all"
      href="http://education.deterlab.net/stylesheets/common.css">
    <link rel="stylesheet" type="text/css" charset="utf-8"
      media="screen"
      href="http://education.deterlab.net/stylesheets/screen.css">
  </head>
  <body dir="ltr" lang="en">
    <div id="page" dir="ltr" lang="en">
      <h1>POSIX Permissions and Stateful Firewalls</h1>
      <div class="author">Created by: Peter A. H. Peterson and Dr. Peter
        Reiher, UCLA {pahp, reiher}@cs.ucla.edu<br>
        Updated for CS 556 Fall 2013: Dr. Indrajit Ray and Tarik Moataz,
        CSU {indrajit, tmoataz}@cs.colostate.edu<br>
      </div>
      <div class="due-date">Project due date: October 03, 2013 before
        class on RamCT<br>
      </div>
      <div class="table-of-contents">
        <div class="table-of-contents-heading">Contents</div>
        <ol type="1">
          <li><a href="#overview">Overview</a> </li>
          <li><a href="#reading">Required Reading</a>
            <ol>
              <li><a href="#posix">POSIX Permissions</a> </li>
              <li><a href="#criticisms">Criticisms</a> </li>
              <li><a href="#sudo">sudo and Alternatives</a> </li>
              <li><a href="#permtools">Software Tools</a>
                <ol>
                  <li><a href="#adduser">adduser, chfn, passwd</a> </li>
                  <li><a href="#addgroup">addgroup</a> </li>
                  <li><a href="#usermod">usermod</a> </li>
                  <li><a href="#chown">chown, chgrp</a> </li>
                  <li><a href="#chmod">chmod</a> </li>
                </ol>
              </li>
              <li><a href="#firewalls">Firewalls</a> </li>
              <li><a href="#policy">Policy Design</a> </li>
              <li><a href="#nettools">Firewall and Network Testing Tools</a>
                <ol>
                  <li><a href="#netfilter">iptables</a> </li>
                  <li><a href="#nmap">nmap</a> </li>
                  <li><a href="#ifconfig">ifconfig</a> </li>
                  <li><a href="#telnet">telnet</a> </li>
                  <li><a href="#netcat">netcat</a> </li>
                </ol>
              </li>
            </ol>
          </li>
          <li><a href="#intro">Introduction</a> </li>
          <li><a href="#assignment">Assignment Instructions</a>
            <ol>
              <li><a href="#setup">Setup</a>
                <ol>
                  <li><a href="#saving">Saving your work</a></li>
                  <li><a href="#restoring">Restoring your work</a></li>
                </ol>
              </li>
              <li><a href="#tasks">Tasks</a>
                <ol>
                  <li><a href="#homedirsec">Home Directory Security</a>
                  </li>
                  <li><a href="#ballotbox">The Ballot Box</a> </li>
                  <li><a href="#tpsreports">The TPS Reports Directory</a>
                  </li>
                  <li><a href="#sudoprobs">sudo Problems</a> </li>
                  <li><a href="#firewall">Firewall Configuration</a> </li>
                </ol>
              </li>
              <li><a href="#tips">Tips and Tricks</a>
                <ol>
                  <li><a href="#ambiguity">Resolving ambiguities</a></li>
                  <li><a href="#envvars">Using environment variables</a></li>
                  <li><a href="#testing">Testing your firewall</a></li>
                </ol>
              </li>
              <li><a href="#glitches">What Can Go Wrong</a> </li>
            </ol>
            <!-- <li><a href="#extra">Extra Credit (optional section)</a> -->
          </li>
          <li><a href="#submission">Submission Instructions</a> </li>
        </ol>
      </div>
      <span class="anchor" id="overview"></span>
      <h2>Overview</h2>
      <p>The purpose of this exercise is to introduce you to filesystem
        and network access control schemes and the "principle of least
        privilege" through the use of POSIX filesystem permissions and <tt>iptables</tt>
        firewalls. </p>
      <p>After this exercise, you will: </p>
      <ol type="1">
        <li>understand the POSIX permissions structure including SUID
          and SGID bits </li>
        <li>understand the essence of the sudo utility and how to
          configure and use it securely. </li>
        <li>be able to apply that knowledge to configure permissions in
          multiple scenarios, such as:
          <ol type="1">
            <li>shared system directories </li>
            <li>user home directories and private directories </li>
            <li>privileged system directories </li>
            <li>unprivileged temporary directories </li>
            <li>editing important configuration files </li>
            <li>restarting system processes </li>
            <li>potential privilege escalation problems </li>
          </ol>
        </li>
        <li>understand the basics of stateful firewalls </li>
        <li>be able to apply that knowledge to configure a basic
          firewall in Linux using iptables. </li>
      </ol>
      <p><span class="anchor" id="posix"></span><span class="anchor"
          id="unix"></span> <span class="anchor" id="reading"></span> </p>
      <h2>Required Reading</h2>
      <h3>POSIX Permissions</h3>
      <span class="anchor" id="posix"></span>
      <p>The Portable Operating System Interface, or POSIX, is IEEE
        standards family <strong>IEEE 1003.1</strong> and represents an
        attempt to formalize the API for variants of the Unix operating
        system. POSIX specifies standards for the kernel APIs (including
        many internal functions like permissions, threads, networking,
        and interprocess communication), commands, required utilities
        and user-level APIs (including many utilities and scripting
        tools like awk, echo, ed, sh, vi, basic I/O, and more), and a
        conformance test that can be run on many platforms. POSIX is
        very widely disseminated and has been in use for almost 20
        years, but is a closed standard (i.e. proprietary). As a result,
        it is expensive to be certified; this has resulted in many free
        operating systems such as FreeBSD and Linux being substantially
        compliant but not officially able to use the moniker "POSIX
        Compliant". An alternative to POSIX is the <a class="http"
          href="http://en.wikipedia.org/wiki/Single_UNIX_Specification">Single
UNIX

          Specification</a>, developed by the Austin Group.
        Unfortunately, it is also proprietary and expensive. </p>
      <p>The expense has not been prohibitive for motivated commercial
        vendors however, and POSIX has been extremely influential in
        coalescing and standardizing those elements that are
        characteristically UNIX-like. Furthermore, POSIX is a standard
        that influences software design and operating system
        implementations in seemingly unlikely places -- for example,
        Windows NT and its derivatives (2000, XP, and beyond) can be
        "POSIX compliant" with the addition of software packages and the
        enabling of certain features. This broad influence -- existing
        before the public explosion of the Internet -- has helped to
        make software and systems similar in fundamental ways. This, in
        turn, simplifies many portability and interoperability problems.
      </p>
      <p>One of the enduring legacies of Bell Labs UNIX and the POSIX
        standard are traditional Unix file system permissions, which are
        a simple system of permissions stored in the file system and and
        kernel and evaluated to mediate access to system resources.
        Additionally, since devices are files in Unix, file system
        permissions also mediate control over many aspects of the
        operating system. </p>
      <p>In most Unix and Unix-like operating systems, the permission
        system is extremely simple. Each file has <tt>read</tt>, <tt>write</tt>,
        and <tt>execute</tt> permissions set for each of three groups
        of users called "access classes". The three classes are <tt>user</tt>
        (owner), <tt>group</tt>, and <tt>other</tt>; each access class
        represents one or more users in the following way: </p>
      <ul>
        <li>
          <p>Users each have unique user identifiers (userids or UIDs,
            listed in <tt>/etc/passwd</tt>) that only they control. </p>
        </li>
        <li>
          <p>Groups are arbitrary collections of users. Each group has
            its own group identifier (groupid or GID, defined in <tt>/etc/group</tt>).
Often,

            every user on the system has a personal group used for
            sharing data with a limited set of other users. </p>
          <ul>
            <li>
              <p>Example: the <tt>group</tt> class <tt>cdrom</tt>
                usually contains a list of all users granted permission
                to access the system's CD-rom drive. </p>
            </li>
            <li>
              <p>Example: the user <tt>sonny</tt> has a group <tt>sonny</tt>
                by default; the user <tt>cher</tt> can be added as a
                member of group <tt>sonny</tt> so that they can share
                resources between themselves but no one else. </p>
            </li>
          </ul>
        </li>
        <li>
          <p>Finally, the membership of the <tt>other</tt> class for
            each file is dependent on the <tt>user</tt> and members of
            the <tt>group</tt> class -- <strong>the</strong> <tt>other</tt>
            <strong>class does not represent "all users!"</strong>
            Specifically, the <tt>other</tt> class represents "everyone
            that is <em>not</em> the <tt>user</tt> (owner) of the file
            and <em>or</em> a member of the file's <tt>group</tt>
            class." This fact allows us to express more meaningful
            permissions by strictly dividing all system users into three
            non-overlapping sets. </p>
          <ul>
            <li>
              <p>A more precise way of stating this is to say that <tt>other</tt>
                represents the the list of all users on the system,
                minus the union of the <tt>user</tt> and <tt>group</tt>
                classes. </p>
            </li>
            <li>
              <p>Example: There are three users on a system: <tt>sonny</tt>,
                <tt>cher</tt>, and <tt>donovan</tt>. <tt>sonny</tt>
                owns a file whose group access class is set to the group
                <tt>sonny</tt>, which contains the user <tt>cher</tt>.
                The <tt>other</tt> class consists only of <tt>donovan</tt>,
                because he is not the owner nor in the group <tt>sonny</tt>.
              </p>
            </li>
          </ul>
        </li>
      </ul>
      <p>Each access class is encoded by 3 bits. Each bit present grants
        an additional permission from the set <tt>read</tt>, <tt>write</tt>,
        and <tt>execute</tt>. When you list files in long form (with
        the option <tt>-l</tt>), you will see the permissions written
        out in the leftmost column as a bitstring with the letters <tt>r</tt>,
        <tt>w</tt>, and <tt>x</tt> in the order <tt>user</tt>, <tt>group</tt>,
        and <tt>other</tt>: </p>
      <p>Here's what it looks like "in the wild": </p>
      <p></p>
      <pre>$ ls -alh<br>-rw-r--r--   1 pahp console  18K May 16  2006 gpl.txt<br>drwx------   5 pahp console  512 May 21  2006 john-1.7.2/<br>lrwxrwxrwx   1 pahp console   25 Sep 13 20:45 labs -&gt; /proj/some/link/<br>-rwxr--r--   1 pahp console  171 Sep  9 09:18 loadimage.sh*<br>drwxrwxrwx   1 pahp console  512 Sep 13 20:45 worldwriteable/<br>^ ^  ^  ^--- other permissions<br>| |  '------- group permissions<br>| '---------- user permissions<br>'------------ file type: d=directory, l=symbolic link, - means regular file<br></pre>
      <p>Here's an example bitstring split into components: </p>
      <p></p>
      <pre>   d     rwx     rwx    rwx<br>type    user    group  other<br></pre>
      <p>In the above example, the owner of the file <tt>gpl.txt</tt>
        has read and write permission because the <tt>owner</tt> part
        of the bitstring is set to <tt>rw-</tt>. The owner (<tt>pahp</tt>)
        cannot execute this file, but that doesn't matter because it's
        just a text file. The group class <tt>console</tt> can read the
        file, as can the members of the other class -- everyone else. </p>
      <p>The directory <tt>john-1.7.2</tt> is only accessible by the
        owner and nobody else. Notice the <tt>d</tt> in the first
        place; this means that the file is a directory. </p>
      <p>The file <tt>labs</tt> is a "<a class="http"
          href="http://en.wikipedia.org/wiki/Symbolic_link">symbolic
          link</a>" (sometimes called "soft link") to the directory <tt>/proj/some/link/</tt>.
        Symbolic links are a special kind of file that is a pointer to a
        disk location (a "pathname" which may or may not exist).
        Permissions on symbolic links do not work as their <tt>lrwxrwxrwx</tt>
        permissions might lead you believe. </p>
      <p>In addition to the 9 bits required to store the <tt>user</tt>,
        <tt>group</tt>, and <tt>other</tt> permissions of a file, there
        are three kinds of "additional permissions" that are rarely used
        but are extremely important to understand. The additional
        permissions are known as the <em>setuid bit</em>, <em>setgid
          bit</em>, and <em>sticky bit</em>. Each special bit has a
        different function depending on where it is used: </p>
      <p>When the the special bits are used on regular files: </p>
      <ul>
        <li>
          <p>The setuid bit on an executable file means that the file
            will run as the userid of the file's <em>owner</em> as
            opposed to the userid of the user executing the file. This
            is done to allow users to perform tasks that temporarily
            require the user to be someone else, such as changing
            passwords or restarting a service. Any program with the UID
            bit set must be carefully written so as to block all misuse.
            Innumerable vulnerabilities have stemmed from setuid <strong>root</strong>
            programs with security holes that allowed users to execute
            other commands as root. </p>
        </li>
        <li>
          <p>The setgid bit on an executable file is like the setuid
            bit, except that the process gains the effective user of the
            file's <em>group</em>, not its owner or the user executing
            the file. </p>
        </li>
        <li>The "sticky bit" was used in the olden days to tell the
          kernel to keep an executable's image in memory so that it
          would not have to be reloaded from disk. This was commonly
          done with programs such as editors that were used regularly
          but had a significant load time. Modern systems use the
          "sticky bit" for other uses. </li>
      </ul>
      <p>When the special bits are used on directories, they have
        different meanings altogether. Search online to discover what
        those meanings are on Linux systems. </p>
      <p>Every file has permissions of some kind set for the each of the
        three classes, using the three types of basic permissions: <tt>read</tt>,
        <tt>write</tt>, and <tt>execute</tt> (and the three special
        bits). These permissions have a default value (based on the
        system umask) when the file is created. Permissions can be
        changed with command line utilities such as <tt>chmod</tt> and
        <tt>chown</tt>, which are discussed <a href="#permtools">later
          in this document</a>. </p>
      <p>These permissions are fairly self explanatory when applied to
        files, but when applied to directories their meanings are <strong>not

          always intuitive</strong>. In particular, permissions set on a
        directory <strong>do not always apply to that directory's
          contents</strong>, and the concepts of "read", "write", and
        "execute" as they pertain to directories is not obvious. (It
        helps to think of a directory as a file which contains links to
        other files, rather than as a nested series of containers --
        experiment on DETER to determine how they really interact!) </p>
      <p>Furthermore, while the special bits are commonly overlooked,
        they have important meanings with <strong>incredible
          significance</strong> in terms of security. You are encouraged
        to play with these permissions and read other materials in order
        to fully understand how they are interpreted. </p>
      <p><span class="anchor" id="criticisms"></span> </p>
      <h3>Criticisms</h3>
      <p>Traditional Unix permissions date back to the early 1970s.
        While simple and inexpensive to implement and evaluate, they
        have long been criticized for being out of date and woefully
        inexpressive compared to the power of other access control
        systems. Other systems (such as Microsoft Windows and other ACL
        models for Unix) have more than three access groups, nested
        groups, explicit deny lists, the ability to specify write
        permissions for changing, creating, and deleting (with Unix
        permissions they are largely the same), the ability to consider
        arbitrary state in evaluating the ACLs (such as time of day,
        network address, etc.), the ability to make files invisible to
        unprivileged users, and many other features that traditional
        Unix permissions lack. </p>
      <p>Another important and oft-criticized fact is that Unix
        permissions do not exactly reflect the current state of the
        permissions configuration on the system. For example, while Unix
        checks the file permissions at the moment a file is <em>opened</em>,
        it only checks those permissions <em>once</em> for each <tt>open</tt>
        system call. This means that the permissions are only tested
        when you <em>first
          open the file for reading, writing, or executing</em>, <strong>not</strong>
        each time you access or modify the file's contents via an open
        file descriptor. If a user opens a file, and immediately
        thereafter all permissions on that file for that user are
        removed, the user with the open file descriptor will <em>still</em>
        have access to the resource according to the permissions set <em>when
          the file was opened</em>, even if the <em>current</em>
        permissions deny reading, writing, or execution. </p>
      <p>Furthermore, the traditional Unix permissions and
        authentication system assigns group membership and other
        credentials at login time and <em>never</em> checks them again
        -- this means that system password, login permission, group
        membership details in <tt>/etc/group</tt> and other details
        changed <em>after</em> you log in are <strong>not</strong>
        reflected in your processes until you log out and log back in or
        the process with those credentials is restarted. For example,
        this means that any change to a user group is fully applied only
        when all affected processes have been restarted. Another example
        is that if an attacker steals a password and logs in to a system
        before that account is disabled or the password is changed, the
        attacker will still have that level of authentication until he
        or she logs out. </p>
      <div class="infobox">
        <p><img src="idea.png"> This is an example of a <i>time-of-check
            vs. time-of-use</i> (TOCTOU) problem. </p>
      </div>
      <p>These design decisions were made to limit the space occupied by
        and CPU cycles spent evaluating system permissions. As long as
        the semantics of the system (including the above criticisms) are
        fully understood, it can be an effective, acceptably secure
        solution for many purposes. In fact, in some ways, its
        simplicity and even naivete make it more transparent and easily
        understandable when compared to more complex systems. For these
        and many other reasons, the traditional Unix file permissions
        are still in wide use, over 40 years after their initial
        deployment. </p>
      <p><span class="anchor" id="sudo"></span> </p>
      <h3>sudo and Alternatives</h3>
      <p>Some applications simply require stronger guarantees, finer
        granularity, or other features that the traditional permissions
        cannot express. For those applications, users have many
        alternatives. <tt>sudo</tt> is one simple extension to
        traditional Unix permissions that has become very popular. </p>
      <p><strong>sudo</strong> is a setuid root application with its own
        ACL (stored in <tt>/etc/sudoers</tt>) that specifies, with fine
        granularity, tasks that users and groups can perform as root.
        For example, sudo could be used to allow a user to act as root
        in order to kill processes with a specific name. The user would
        otherwise have no additional privileges. This is an example of a
        perfect use for setuid root programs -- granting
        strongly-constrained privileges to unprivileged users. </p>
      <p>However, sudo is a double edged sword. On the one hand, it
        greatly enhances the expressiveness of Unix permissions without
        actually changing the permissions system. On the other hand, if
        improperly configured, it offers <strong>easy access to root</strong>.
        For more information on sudo and the sudoers ACL format, please
        see the manpages for sudo and sudoers (the configuration file),
        or other sudo-related material online (in particular regarding
        sudo exploits). </p>
      <p>Beyond sudo, two broader and more revolutionary alternatives
        for Linux permissions include SELinux and grsecurity, while
        other options exist including LDAP, Novell eDirectory, and other
        permissions systems for other operating systems. (We won't be
        using any of these.) <span class="anchor" id="permtools"></span>
      </p>
      <h3>Software Tools</h3>
      <p> <span class="anchor" id="adduser"></span> </p>
      <p></p>
      <h4>adduser, chfn, passwd: add users to a system</h4>
      <p> <tt>adduser</tt> is the tool available for adding users to
        the system. To create a new user, execute: </p>
      <p></p>
      <pre>$ adduser username<br></pre>
      <p> <tt>adduser</tt> will copy files from the <tt>/etc/skel</tt>
        directory to become the new homedir of the new user in the <tt>/home/</tt>
        directory. You can specify a different home directory or
        automatically add the new user to groups; those options can be
        found in the <tt>adduser</tt> manpage. </p>
      <p><tt>adduser</tt> does not set any <tt>finger</tt> information
        for the user (this is not strictly necessary anyway), but the
        tool <tt>chfn</tt> will do that: </p>
      <p></p>
      <pre>$ sudo chfn jimbo<br>Changing finger information for jimbo.<br>Name []: ...<br></pre>
      <p> By default, the user is created with a "locked out" account
        with no password set. To set the password, use the command <tt>passwd</tt>:
      </p>
      <p></p>
      <pre>$ sudo passwd jimbo<br>Changing password for user jimbo.<br>New Unix password:<br>Retype new Unix password:<br>passwd: all authentication tokens updated successfully.<br></pre>
      <p> <tt>passwd</tt> will complain if it doesn't like the password
        you enter, but will accept anything with enough prodding. </p>
      <p>Once an account is created, you can log into it in a number of
        ways: </p>
      <ol type="1">
        <li>
          <p>If logged in to the system where you created the account,
            you can execute <tt>ssh&nbsp;newuser@localhost</tt> to
            reconnect locally as the new user with the new password. </p>
        </li>
        <li>
          <p>If local, you can also use the <tt>su</tt> command <tt>su&nbsp;newuser</tt>
            to change to that user. This does not always update all
            access credentials, however. This method can also be used to
            become root by entering <tt>sudo&nbsp;su&nbsp;-</tt>. </p>
        </li>
        <li>
          <p>If logged in to <tt>users.deterlab.net</tt>, you can ssh
            to the node as the new user. </p>
        </li>
      </ol>
      <p><span class="anchor" id="addgroup"></span> </p>
      <p></p>
      <h4>groupadd: add groups to a system</h4>
      <p> <tt>groupadd</tt> adds a new group to the system with a
        unique ID (by default). Example: </p>
      <p></p>
      <pre>$ groupadd newgroup<br></pre>
      <p> See <tt>man&nbsp;groupadd</tt> for more information. </p>
      <p><span class="anchor" id="usermod"></span> </p>
      <p></p>
      <h4>usermod: modify a user</h4>
      <p> <tt>usermod</tt> can be used to modify many details of a
        preexisting user account. For more information, see <tt>man&nbsp;usermod</tt>.
      </p>
      <p><span class="anchor" id="chown"></span> </p>
      <p></p>
      <h4>chown, chgrp: change ownership of a file</h4>
      <p> <tt>chown</tt> stands for <strong>ch</strong>ange <strong>own</strong>ership
and

        is (unsurprisingly) used to change the owner and group of a
        file. </p>
      <p>The syntax is very simple. To change the owner of a file,
        execute: </p>
      <p></p>
      <pre>$ chown newowner filename<br></pre>
      <p> To change the owner and group classes of a file, execute: </p>
      <p></p>
      <pre>$ chown newowner:newgroup filename<br></pre>
      <p> <tt>chgrp</tt> stands for <strong>ch</strong>ange <strong>gr</strong>ou<strong>p</strong>
        and works very similarly to <tt>chown</tt>. To change the group
        of a file, execute: </p>
      <p></p>
      <pre>$ chgrp newgroup filename<br></pre>
      <p> Recursive and other options exist; see <tt>man&nbsp;chown</tt>
        or <tt>man&nbsp;chgrp</tt> for more information. </p>
      <p><span class="anchor" id="chmod"></span> </p>
      <p></p>
      <h4>chmod: change the mode of a file</h4>
      <p> chmod stands for <strong>ch</strong>ange <strong>mod</strong>e
        and is used to change the permissions mode of a file. Earlier,
        we discussed how the POSIX ACL has three access classes. User
        (or owner), group, and other (or world). The permissions mode
        for each access class can be changed by the <tt g="">chmod</tt>
        command. </p>
      <p>There are two ways to use <tt>chmod</tt>; one is an <em>absolute
numeric

          mode</em> and the other is a <em>symbolic mode</em>. </p>
      <p></p>
      <h5>chmod: absolute -- setting the permissions explicitly</h5>
      <p> In the absolute mode, <tt>chmod</tt> takes a file mode in 3
        or 4 digits, each of which represents the absolute permission
        mode for one access class expressed in octal, where each number
        is a sum of the permission bits. Each permission has a unique
        value: <tt g="">read</tt> permission is <tt class="backtick">4</tt>,
        <tt class="backtick">write</tt> permission is <tt
          class="backtick">2</tt>, and <tt class="backtick">execute</tt>
        permission is <tt class="backtick">1</tt>. These values
        represent the position of the permission in a 3-bit value. </p>
      <p>For example, the mode <tt g="">777</tt> means "full
        permissions" because all bits are set in each access class.
        Similarly, <tt class="backtick">000</tt> means "no permissions"
        because all bits are unset in each access class. </p>
      <p>The 3-digit mode <tt g="">777</tt> is the equivalent to the
        4-digit mode <tt class="backtick">0777</tt> where the leading <tt
          class="backtick">0</tt> represents the "special" permission
        class of setuid, setgid, and sticky. Likewise, the modes <tt
          class="backtick">000</tt> and <tt class="backtick">0000</tt>
        are equivalent and represent the absence of permission. (The
        owner of the file and root still have the ability to change the
        file's mode by virtue of their ownership and superuser status.)
        Finally, if the 3-digit mode is used, <tt class="backtick">chmod</tt>
        always assumes that the special access class is <tt
          class="backtick">0</tt>. Therefore, if you set an suid-root
        file to mode <tt class="backtick">777</tt>, <tt
          class="backtick">chmod</tt> assumes that you meant mode <tt
          class="backtick">0777</tt>, which would take away the special
        permissions. This is consistent if you remember that octal modes
        represent <em>absolute permissions</em> and <em>the special
          group class is assumed to be <tt class="backtick">0</tt> if a
          3-digit mode is provided.</em> </p>
      <p>The following is a table to help calculate permission modes: </p>
      <div>
        <table style="width: 200px;">
          <tbody>
            <tr>
              <td colspan="12" style="text-align: center;">
                <p><strong>chmod absolute values</strong> </p>
              </td>
            </tr>
            <tr>
              <td colspan="3" style="text-align: center;">
                <p> special<em> </em> </p>
              </td>
              <td colspan="3" style="text-align: center;">
                <p> user<em> </em> </p>
              </td>
              <td colspan="3" style="text-align: center;">
                <p> group<em> </em> </p>
              </td>
              <td colspan="3" style="text-align: center;">
                <p> other<em> </em> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><strong>s</strong> </p>
              </td>
              <td>
                <p><strong>g</strong> </p>
              </td>
              <td>
                <p><strong>t</strong> </p>
              </td>
              <td>
                <p><strong>r</strong> </p>
              </td>
              <td>
                <p><strong>w</strong> </p>
              </td>
              <td>
                <p><strong>x</strong> </p>
              </td>
              <td>
                <p><strong>r</strong> </p>
              </td>
              <td>
                <p><strong>w</strong> </p>
              </td>
              <td>
                <p><strong>x</strong> </p>
              </td>
              <td>
                <p><strong>r</strong> </p>
              </td>
              <td>
                <p><strong>w</strong> </p>
              </td>
              <td>
                <p><strong>x</strong> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p>4 </p>
              </td>
              <td>
                <p>2 </p>
              </td>
              <td>
                <p>1 </p>
              </td>
              <td>
                <p>4 </p>
              </td>
              <td>
                <p>2 </p>
              </td>
              <td>
                <p>1 </p>
              </td>
              <td>
                <p>4 </p>
              </td>
              <td>
                <p>2 </p>
              </td>
              <td>
                <p>1 </p>
              </td>
              <td>
                <p>4 </p>
              </td>
              <td>
                <p>2 </p>
              </td>
              <td>
                <p>1 </p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <p> For example, full access is <tt g="">0777</tt>, which
        represents: </p>
      <div>
        <table>
          <tbody>
            <tr>
              <td colspan="3" style="text-align: center;">
                <p> special<em> </em> </p>
              </td>
              <td colspan="3" style="text-align: center;">
                <p> user<em> </em> </p>
              </td>
              <td colspan="3" style="text-align: center;">
                <p> group<em> </em> </p>
              </td>
              <td colspan="3" style="text-align: center;">
                <p> other<em> </em> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><strong>s</strong> </p>
              </td>
              <td>
                <p><strong>g</strong> </p>
              </td>
              <td>
                <p><strong>t</strong> </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p><strong>r</strong> </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p><strong>w</strong> </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p><strong>x</strong> </p>
              </td>
              <td style="background-color: rgb(128, 255, 128);">
                <p><strong>r</strong> </p>
              </td>
              <td style="background-color: rgb(128, 255, 128);">
                <p><strong>w</strong> </p>
              </td>
              <td style="background-color: rgb(128, 255, 128);">
                <p><strong>x</strong> </p>
              </td>
              <td style="background-color: rgb(128, 128, 255);">
                <p><strong>r</strong> </p>
              </td>
              <td style="background-color: rgb(128, 128, 255);">
                <p><strong>w</strong> </p>
              </td>
              <td style="background-color: rgb(128, 128, 255);">
                <p><strong>x</strong> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p>4 </p>
              </td>
              <td>
                <p>2 </p>
              </td>
              <td>
                <p>1 </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p>4 </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p>2 </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p>1 </p>
              </td>
              <td style="background-color: rgb(128, 255, 128);">
                <p>4 </p>
              </td>
              <td style="background-color: rgb(128, 255, 128);">
                <p>2 </p>
              </td>
              <td style="background-color: rgb(128, 255, 128);">
                <p>1 </p>
              </td>
              <td style="background-color: rgb(128, 128, 255);">
                <p>4 </p>
              </td>
              <td style="background-color: rgb(128, 128, 255);">
                <p>2 </p>
              </td>
              <td style="background-color: rgb(128, 128, 255);">
                <p>1 </p>
              </td>
            </tr>
            <tr>
              <td colspan="3" style="text-align: center;">
                <p> 0 </p>
              </td>
              <td colspan="3" style="text-align: center;
                background-color: rgb(255, 128, 128);">
                <p><strong>7</strong> </p>
              </td>
              <td colspan="3" style="text-align: center;
                background-color: rgb(128, 255, 128);">
                <p> <strong>7</strong> </p>
              </td>
              <td colspan="3" style="text-align: center;
                background-color: rgb(128, 128, 255);">
                <p> <strong>7</strong> </p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <p> There are no special bits set, so the <tt g="">special</tt>
        octal digit is <tt class="backtick">0</tt>, while all three
        bits in each other class are set. Each set of bits totals 7 (4 +
        2 + 1), so the mode is <tt class="backtick">0777</tt>. </p>
      <p>Another example is mode <tt g="">2755</tt>, which represents <tt
          class="backtick">setgid</tt> (2), plus "full access" for <tt
          class="backtick">user</tt> (4 + 2 + 1) and <tt
          class="backtick">write</tt> and <tt class="backtick">execute</tt>
        (4 + 1) access for both the <tt class="backtick">group</tt> and
        <tt class="backtick">other</tt> class. </p>
      <div>
        <table>
          <tbody>
            <tr>
              <td colspan="3" style="text-align: center;">
                <p> special<em> </em> </p>
              </td>
              <td colspan="3" style="text-align: center;">
                <p> user<em> </em> </p>
              </td>
              <td colspan="3" style="text-align: center;">
                <p> group<em> </em> </p>
              </td>
              <td colspan="3" style="text-align: center;">
                <p> other<em> </em> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><strong>s</strong> </p>
              </td>
              <td style="background-color: rgb(128, 128, 128);">
                <p><strong>g</strong> </p>
              </td>
              <td>
                <p><strong>t</strong> </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p><strong>r</strong> </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p><strong>w</strong> </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p><strong>x</strong> </p>
              </td>
              <td style="background-color: rgb(128, 255, 128);">
                <p><strong>r</strong> </p>
              </td>
              <td>
                <p><strong>w</strong> </p>
              </td>
              <td style="background-color: rgb(128, 255, 128);">
                <p><strong>x</strong> </p>
              </td>
              <td style="background-color: rgb(128, 128, 255);">
                <p><strong>r</strong> </p>
              </td>
              <td>
                <p><strong>w</strong> </p>
              </td>
              <td style="background-color: rgb(128, 128, 255);">
                <p><strong>x</strong> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p>4 </p>
              </td>
              <td style="background-color: rgb(128, 128, 128);">
                <p>2 </p>
              </td>
              <td>
                <p>1 </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p>4 </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p>2 </p>
              </td>
              <td style="background-color: rgb(255, 128, 128);">
                <p>1 </p>
              </td>
              <td style="background-color: rgb(128, 255, 128);">
                <p>4 </p>
              </td>
              <td>
                <p>2 </p>
              </td>
              <td style="background-color: rgb(128, 255, 128);">
                <p>1 </p>
              </td>
              <td style="background-color: rgb(128, 128, 255);">
                <p>4 </p>
              </td>
              <td>
                <p>2 </p>
              </td>
              <td style="background-color: rgb(128, 128, 255);">
                <p>1 </p>
              </td>
            </tr>
            <tr>
              <td colspan="3" style="text-align: center;
                background-color: rgb(128, 128, 128);">
                <p> <strong>2</strong> </p>
              </td>
              <td colspan="3" style="text-align: center;
                background-color: rgb(255, 128, 128);">
                <p> <strong>7</strong> </p>
              </td>
              <td colspan="3" style="text-align: center;
                background-color: rgb(128, 255, 128);">
                <p> <strong>5</strong> </p>
              </td>
              <td colspan="3" style="text-align: center;
                background-color: rgb(128, 128, 255);">
                <p> <strong>5</strong> </p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <p> Absolute modes are applied like this: </p>
      <p></p>
      <pre>$ chmod 0755 somefile.sh<br></pre>
      <p> Absolute mode is great for setting things to be exactly what
        you want, or imposing a radically different order onto a file or
        directory, but it's not very good for adding the sticky bit to a
        file. For that kind of work (or if the octal modes just confuse
        you) the symbolic mode is well suited. </p>
      <p></p>
      <h5>chmod: symbolic -- more user-friendly</h5>
      <p> The symbolic mode works pretty much the way you would expect.
        To add the <tt g="">execute</tt> bit to the <tt
          class="backtick">user</tt> class, you would execute a command
        like this: </p>
      <p></p>
      <pre>$ chmod u+x somefile.sh<br></pre>
      <p> Or to add <tt g="">execute</tt> to all three classes: </p>
      <p></p>
      <pre>$ chmod ugo+x somefile.sh<br></pre>
      <p> To make a file <tt g="">setuid</tt>: </p>
      <p></p>
      <pre>$ chmod u+s somefile.sh<br></pre>
      <p> To remove all permissions: </p>
      <p></p>
      <pre>$ chmod ugo-rwxsgt somefile.sh<br></pre>
      <p> Some people are so put off by the absolute mode that they
        never learn it -- you'll find with experience that both methods
        of setting permissions can be expeditious depending on the
        situation. More information is available in the <tt g="">chmod</tt>
        manpage. </p>
      <p>Regardless of how you set permissions, it is critical that you
        use the "principle of least privilege" and only grant the
        privileges that are necessary for proper operation. </p>
      <p><span class="anchor" id="firewalls"></span></p>
      <h2>Firewalls</h2>
      <h3>Stateless Firewalls</h3>
      <p>In the late 1980s, the Internet was just beginning to grow
        beyond its early academic and governmental applications into the
        commercial and personal worlds. The <a class="http"
          href="http://en.wikipedia.org/wiki/Morris_worm">Great Internet
          Worm</a> in November of 1988 infected around 6,000 hosts
        (roughly 10% of the Internet) in the first major infection of
        its kind and helped to focus research and awareness on securing
        computers from unauthorized access. It was in this environment
        that the first firewalls were written about and developed at
        Digital Equipment Corporation (DEC) and Bell Labs (AT&amp;T). </p>
      <p>The first functional firewalls inspected individual packet
        headers without regard for established connections, other
        packets, or their contents. These kind of firewalls became known
        as "packet filters" because they literally filtered the packets
        one by one according to a set of criteria, not unlike a quality
        control inspector on an assembly line. For TCP and UDP, these
        criteria could be reduced essentially to the source and
        destination addresses and ports in the packet header. For
        example, a packet filter could reject or drop any packets
        destined for port 23 (telnet) on host 10.10.10.10 from any
        address other than 10.10.10.11. This kind of filter could
        rapidly and inexpensively inspect and classify packets without
        using much space (although they were not very "smart"). </p>
      <p>Unsurprisingly, simple packet filters are not adequate for many
        applications, such as the <a class="http"
          href="http://en.wikipedia.org/wiki/Ftp">File Transfer Protocol</a>
        (FTP), because these protocols open additional connections on
        random ports that can not be anticipated or recognized by the
        firewall since it does not understand or consider the state of
        any connection. </p>
      <p>This kind of simple "packet filter" ultimately became known as
        a "stateless firewall". </p>
      <h3>Stateful Firewalls</h3>
      <p>"Stateful firewalls" arrived not long after "stateless
        firewalls". Stateful firewalls keep tables of network
        connections and states in memory in order to determine if a
        packet is part of a preexisting network connection, the start of
        a new and legitimate connection, or an unwanted or unrelated
        packet. This kind of firewall can recognize, for example, that a
        new connection on a random high port from a host with a
        preexisting FTP connection is a related connection and should be
        allowed. Another difference is that while a stateless firewall
        will allow all packets from acceptable hosts to an open port, a
        stateful firewall can be configured to allow packets to that
        port only if a legitimate TCP connection (or some other
        protocol) has already been established in some acceptable way.
        Understanding protocol state essentially gives stateful
        firewalls vastly more criteria in deciding whether to accept or
        reject a packet, which translates into finer granularity. </p>
      <p>The cutting edge of firewall design today is what is called an
        "application-layer firewall", which is a firewall that performs
        "deep packet inspection". This means that the firewall is
        capable of looking not just at the header of the packets and the
        state of the connection, but at the payload of the packet in
        context of what the application processing the packets will do.
        For example, an application-layer firewall could be used to
        block Java applets from HTTP traffic by inspecting the packets
        and stripping Java code or dropping the packets entirely. In
        order to do this, it must understand what applet code looks like
        within the payload portion of any HTTP traffic stream. An
        application-layer firewall essentially has total control over
        the network stream, although this control comes at a significant
        expense in terms of CPU time and software complexity. </p>
      <p>Most firewalls in use today lie somewhere between the stateful
        firewall and the application-layer firewall. These firewalls
        function essentially as a stateful firewall, but may understand
        enough of a few applications to perform some application-layer
        tasks. It is also common to couple a primarily stateful firewall
        (such as netfilter/iptables) with separate application layer
        firewalls for individual applications. </p>
      <p><span class="anchor" id="policy"></span> </p>
      <h3>Firewall Policy Design</h3>
      <p>People imagine many different things when they hear the term "<a
          class="http" href="http://en.wikipedia.org/wiki/Firewall">firewall</a>"
        in the context of computer networking. Some envision an
        impenetrable wall of flame <em>[at least I did --ed.]</em>. A
        Hollywood screenwriter might envision Harrison Ford battling
        kidnappers. A mechanic might envision the wall between the
        engine and passenger compartment of a car. Yet mysteriously,
        every firewall is illustrated as a boring, red brick wall,
        typically with no fire in sight. </p>
      <p>Actually, the brick wall isn't that strange -- the name
        "firewall" comes from the brick walls in buildings placed to
        stop the spread of a fire from one area to another. But no
        matter who you are or what you see in your minds eye, the
        conventional wisdom is that firewalls are used to "keep the bad
        stuff out," whether you're protecting your desktop PC at home,
        your office LAN, or the Pentagon. However, those of us in the
        field of computer security often see firewalls more as a means
        of keeping things <em>in</em> rather than keeping them <em>out</em>.
      </p>
      <p>In one sense, these are two sides of the same coin -- but how
        you design something is (often unconsciously) directly related
        to how you view the problem, and this can lead to very different
        design choices when developing a firewall. The goal of "keeping
        things out" is by definition, exclusively concerned with keeping
        external attackers "outside" the system, with no regard for what
        is inside that is worth protecting, and without considering
        threats (intentional or unintentional) that are <em>already</em>
        inside, like malicious or foolish employees. This is only half
        the picture. In contrast, "keeping things in" by definition
        concerns itself with what is "inside" like sensitive data,
        privileged access, etc., and encourages the designer to consider
        <em>all</em> threats -- both internal and external -- against
        the protected resource. </p>
      <p>Practically speaking, these two goals often result in different
        default policies. The goal of "keeping things out" often results
        in a policy that by default allows anything not considered to be
        a threat. This is called a <strong>default allow</strong>
        policy, and the classic example of this kind of firewall allows
        <strong>all</strong> outbound traffic, but only allows
        "untrusted" inbound traffic to special services, such as a web
        server (which is then responsible for its own security). This is
        better than nothing, but is hardly secure. If an attacker can
        trick someone inside into opening a <a class="http"
          href="http://en.wikipedia.org/wiki/Trojan_horse_%28computing%29">trojan

          horse</a>, the malicious software can exploit the liberal
        egress policy by making connections to a malicious host on the
        Internet, which can be used to send messages to the
        now-compromised system. Incidentally, this is how the firewalls
        on most home routers are designed. </p>
      <p>On the other hand, the "keeping things in" policy usually
        results in a policy that by default <em>denies everything</em>,
        and allows only what is necessary for the proper functioning of
        a system. This embodies the principle of "<a class="http"
          href="http://en.wikipedia.org/wiki/Principle_of_least_privilege">least

          privilege</a>" and in the context of a firewall is called a <strong>default

          deny</strong> policy. A firewall configured this way allows
        only the handful of things that are strictly required. This
        limits inbound traffic as before, but also only allows outbound
        traffic to carefully chosen targets. For example, this might
        only allow oubound traffic to a secured mail server, ssh server,
        and the few web servers required for an employee to accomplish
        their job. This drastically limits the means by which traffic
        can enter <em>or</em> leave the network, and if an employee
        executes a trojan as in the last example, that malicious
        software will not be able to contact its evil master because the
        malicious Internet host will almost certainly not be in the list
        of allowed outbound connections. </p>
      <p>The obvious downside to a "default deny" firewall policy is
        maintenance and inconvenience -- it is harder to install in the
        first place, and any new network service or traffic type on the
        network must be explicitly allowed or it will not function.
        Allowing all outbound traffic significantly cuts down on this
        kind of maintenance -- at the cost of security. <span
          class="anchor" id="tools"></span> </p>
      <h3>Firewall and Network Testing Tools</h3>
      <span class="anchor" id="netfilter"></span>
      <h4>iptables: set and clear rules in netfilter</h4>
      <p> <a class="http" href="http://en.wikipedia.org/wiki/Iptables">iptables</a>
        is actually the user space tool for administering the <tt>netfilter</tt>
        functions and tables in the Linux kernel, but the entire <tt>netfilter</tt>
        and <tt>iptables</tt> package is commonly referred to simply as
        <tt>iptables</tt>. <tt>iptables</tt> has several built-in
        tables of rules (such as <tt>filter</tt> and <tt>nat</tt>) ,
        several built-in "chains" (which are sets of network traffic
        including the built-in INPUT, OUTPUT, and FORWARD for inbound,
        outbound, and routed traffic), a set of powerful loadable
        modules of matching stateful filters, the typical set of
        stateless criteria (such as source, destination, and interface),
        and a set of targets that represent what to do with a matching
        packet. These options allow sophisticated firewalls to be
        defined. </p>
      <p><tt>iptables</tt> can be intimidating and confusing at first
        glance even for veteran sysadmins, but especially to users who
        are not used to configuring firewalls at all or are used to
        configuring firewalls through a GUI. <tt class="backtick">iptables</tt>
        expressive plugins further complicate the syntax. A typical <tt>iptables</tt>
        command looks something like this: </p>
      <p></p>
      <pre>$ iptables -t filter -A INPUT -m state --state NEW -p tcp -s 192.168.0.1 --dport 23 -j REJECT<br></pre>
      <p> Upon closer inspection, <tt>iptables</tt> is revealed to be
        merely a command whose arguments define a single rule for packet
        filtering based on a number of possible criteria. <tt>iptables</tt>
        takes those arguments translates them one command at a time into
        priority-ordered filter rules in the Linux kernel. Thinking of <tt>iptables</tt>
        as a command with arguments can help demystify <tt>netfilter</tt>
        and the process of designing firewalls with <tt>iptables</tt>
        -- let's break down the above <tt class="backtick">iptables</tt>
        command and translate it into English: </p>
      <div>
        <table style="width: 800px;">
          <tbody>
            <tr>
              <td colspan="2" style="text-align: center;">
                <p><strong>iptables command arguments</strong> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p> <strong>command/argument</strong> </p>
              </td>
              <td>
                <p><strong>translation</strong> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><tt class="backtick">iptables</tt> </p>
              </td>
              <td>
                <p><em>We're going to use the iptables tool to insert a
                    new rule into netfilter.</em> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><tt class="backtick">-t&nbsp;filter</tt> </p>
              </td>
              <td>
                <p><em>This rule is going to go in the filter table,
                    which is the built-in packet filtering table. This
                    rule will apply only to:</em> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><tt class="backtick">-A&nbsp;INPUT</tt> </p>
              </td>
              <td>
                <p><em>packets that have been put into the <tt>INPUT</tt>
                    chain either by the kernel or by some previous rule
                    and which:</em> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><tt class="backtick">-m&nbsp;state&nbsp;--state&nbsp;NEW</tt>
                </p>
              </td>
              <td>
                <p><em>represent a new connection,</em> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><tt class="backtick">-p&nbsp;tcp</tt> </p>
              </td>
              <td>
                <p><em>are Transmission Control Protocol (TCP) packets,</em>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><tt class="backtick">-s&nbsp;192.168.0.1</tt> </p>
              </td>
              <td>
                <p><em>are from the host 192.168.0.1,</em> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><tt class="backtick">--dport&nbsp;23</tt> </p>
              </td>
              <td>
                <p><em>and are destined for port 23.</em> </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><tt class="backtick">-j&nbsp;REJECT</tt> </p>
              </td>
              <td>
                <p><em>Reject any matching packet. Processing of all
                    packets matching this rule will instantly jump to
                    the built-in target REJECT, which means that the
                    packet will be rejected by the kernel with some kind
                    of network error message.</em> </p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <p> A few other examples: </p>
      <p></p>
      <pre>$ iptables -p tcp --syn --dport 23 -m connlimit --connlimit-above 2 -j REJECT<br></pre>
      <p> This rule (from <tt>man&nbsp;iptables</tt>) allows 2 telnet
        connections per client host. Note that this rule uses the <tt>connlimit</tt>
        matching module, and rejects additional connections. </p>
      <p></p>
      <pre>$ iptables -A INPUT -i lo -j ACCEPT<br>$ iptables -A OUTPUT -o lo -j ACCEPT<br></pre>
      <p> These rules accepts any inbound or outbound traffic on the
        internal loopback network device (an internal, logical network
        adapter the kernel uses for network communication internal to
        the computer) regardless of state, protocol, source, or
        destination address. The <tt>-i&nbsp;lo</tt> and <tt>-o&nbsp;lo</tt>
        arguments specify the "input interface" and "output interface"
        the packet arrived on. </p>
      <p></p>
      <pre>$IPTABLES -t filter -A INPUT -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT<br>$IPTABLES -t filter -A OUTPUT -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT<br></pre>
      <p> These rules accept all INBOUND and OUTBOUND traffic regardless
        of interface, address, port or protocol. They use the <tt>state</tt>
        matching module, but accept all NEW, RELATED, and ESTABLISHED
        packets (which is basically all traffic). This rule is basically
        like having no firewall at all! </p>
      <p><strong>NEW, RELATED, ESTABLISHED</strong> </p>
      <p>Think of your firewall as a security checkpoint in a big office
        building. There's usually two lines -- one for people with IDs,
        and one for people without IDs. If someone already has an ID,
        they can skip the long line, and go through. If they don't, they
        have to wait to get an ID card or visitor's pass. This is
        analogous to the distinction between <strong>NEW</strong>
        traffic versus <strong>RELATED</strong> or <strong>ESTABLISHED</strong>
        traffic (which you usually see together). Traffic marked <strong>NEW</strong>
        doesn't have an ID badge yet, because it is the first packet of
        a new stream of traffic. On the other hand, a packet of a <strong>RELATED</strong>
        or <strong>ESTABLISHED</strong> stream is part of something
        that by definition has already come through the firewall in the
        past. In other words, the firewall has already given that stream
        a "badge" (which is really an entry in an internal firewall data
        structure). </p>
      <p>Among other things, this means that firewalls are typically
        structured so that the first section passes all accepted <strong>RELATED,ESTABLISHED</strong>
        traffic first, and then carefully allows only certain kinds of <strong>NEW</strong>
        traffic. Why do it in that order? </p>
      <p>While this brief introduction to <tt>iptables</tt> should
        point you in the right direction, there are other features of <tt>iptables</tt>
        not included here that you may want to use for the exercise.
        There are many HOWTOs, tips, and tutorials online in addition to
        the <tt>iptables</tt> manpage; the exercise manual assumes that
        in order to complete the <tt>iptables</tt> exercise, you will
        need to <a class="http" href="http://www.google.com">do some
          research</a> on your own. <span class="anchor" id="nmap"></span>
      </p>
      <h4>nmap: network mapping port scanner</h4>
      <p> <a class="http" href="http://en.wikipedia.org/wiki/Nmap">Nmap</a>
        (<a class="http" href="http://www.insecure.org">homepage</a>) is
        a very popular "<a class="http"
          href="http://en.wikipedia.org/wiki/Port_scanner">port scanner</a>"
        that can be used to determine what kind of services are running
        on a remote or local host, perform <a class="http"
          href="http://en.wikipedia.org/wiki/Passive_OS_Fingerprinting">OS

          fingerprinting</a>, and many other tasks. Nmap is capable of
        performing many tasks in a "stealth mode" designed to not raise
        the suspicion of the victim, but some tasks require more obvious
        techniques. </p>
      <p>Nmap is incredibly powerful, but the basic functionality of the
        application is easy to use: </p>
      <p></p>
      <pre>$ sudo nmap yahoo.com<br><br>Starting Nmap 4.20 ( http://insecure.org ) at 2007-09-22 21:33 PDT<br>Warning: Hostname yahoo.com resolves to 2 IPs. Using 216.109.112.135.<br>Interesting ports on w2.rc.vip.dcn.yahoo.com (216.109.112.135):<br>Not shown: 1694 filtered ports<br>PORT    STATE SERVICE<br>25/tcp  open  smtp<br>80/tcp  open  http<br>443/tcp open  https<br><br>Nmap finished: 1 IP address (1 host up) scanned in 29.990 seconds<br><br>$ sudo nmap www.somehost.edu -P0<br>Starting Nmap 4.20 ( http://insecure.org ) at 2007-09-22 21:34 PDT<br>Interesting ports on dns.somehost.edu (33.xx.111.1):<br>Not shown: 1677 filtered ports<br>PORT     STATE  SERVICE<br>53/tcp   open   domain<br>80/tcp   open   http<br>443/tcp  open   https<br>2048/tcp open   dls-monitor<br>2049/tcp closed nfs<br>2053/tcp open   knetd<br>2064/tcp closed dnet-keyproxy<br>2065/tcp open   dlsrpn<br>2067/tcp open   dlswpn<br>2068/tcp open   advocentkvm<br>2105/tcp open   eklogin<br>2106/tcp open   ekshell<br>2108/tcp open   rkinit<br>2111/tcp open   kx<br>2112/tcp open   kip<br>2120/tcp open   kauth<br>2121/tcp open   ccproxy-ftp<br>2201/tcp open   ats<br>2232/tcp open   ivs-video<br>2241/tcp closed ivsd<br><br>Nmap finished: 1 IP address (1 host up) scanned in 32.385 seconds<br></pre>
      <p> See the Nmap manpage or online documentation for advanced
        features. </p>
      <p><span class="anchor" id="ifconfig"></span> </p>
      <h4>ifconfig: configure Linux network devices</h4>
      <p> <a class="http" href="http://en.wikipedia.org/wiki/Ifconfig">ifconfig</a>
        is the network interface configurator in Linux. It is most
        commonly used by users to see network addresses and statistics,
        but can also be used to enable and disable interfaces, set
        configuration options such as network addresses, and more. </p>
      <p>For the purposes of this exercise, <tt class="backtick">ifconfig</tt>
        will be used to determine what network addresses are running on
        what interfaces. </p>
      <p>To see the current interface configurations: </p>
      <p></p>
      <pre>$ ifconfig<br><br>eth0      Link encap:Ethernet  HWaddr 00:00:5A:00:01:B3<br>          inet addr:64.81.0.256  Bcast:64.81.40.255  Mask:255.255.255.0<br>          inet6 addr: fe80::200:5aff:fe00:1b3/64 Scope:Link<br>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1<br>          RX packets:1826346 errors:0 dropped:0 overruns:0 frame:0<br>          TX packets:1887951 errors:0 dropped:0 overruns:0 carrier:0<br>          collisions:0 txqueuelen:1000<br>          RX bytes:691689933 (659.6 MiB)  TX bytes:1037280707 (989.2 MiB)<br>          Interrupt:58<br><br>eth1      Link encap:Ethernet  HWaddr 00:13:D4:04:44:CA<br>          inet addr:10.10.10.10  Bcast:10.10.10.255  Mask:255.255.0.0<br>          inet6 addr: fe80::213:d4ff:fe04:44ca/64 Scope:Link<br>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1<br>          RX packets:1165519 errors:0 dropped:0 overruns:0 frame:0<br>          TX packets:1549057 errors:0 dropped:0 overruns:0 carrier:0<br>          collisions:0 txqueuelen:1000<br>          RX bytes:428484191 (408.6 MiB)  TX bytes:1780325755 (1.6 GiB)<br>          Interrupt:50<br><br>lo        Link encap:Local Loopback<br>          inet addr:127.0.0.1  Mask:255.0.0.0<br>          inet6 addr: ::1/128 Scope:Host<br>          UP LOOPBACK RUNNING  MTU:16436  Metric:1<br>          RX packets:5808042 errors:0 dropped:0 overruns:0 frame:0<br>          TX packets:5808042 errors:0 dropped:0 overruns:0 carrier:0<br>          collisions:0 txqueuelen:0<br>          RX bytes:6895907043 (6.4 GiB)  TX bytes:6895907043 (6.4 GiB)<br></pre>
      <p> Note that <tt class="backtick">eth0</tt>'s address is
        64.81.0.256, while <tt>eth1</tt>'s address is 10.10.10.10. This
        means that the two interfaces are on different networks. <span
          class="anchor" id="telnet"></span> </p>
      <h4>telnet: cleartext remote shell</h4>
      <p> <a class="http" href="http://en.wikipedia.org/wiki/Telnet">TELNET</a>
        (TELe-NETwork) is a cleartext remote terminal protocol. On its
        face, telnet is very simple; the user issues commands over a TCP
        socket, and the server replies with the results of those
        commands and waits for more input. In practice, this is
        complicated with various network and terminal emulation layers.
        Still, telnet is one of the simplest and oldest network
        protocols still in use. Due to its cleartext nature and low
        level access to the system, telnet is incredibly insecure -- it
        was common in the past for system administrators to log in as
        root using telnet on a hub network connection that could be
        sniffed by any sufficiently prepared attacker. </p>
      <p>Thanks to the advent of Secure Shell (ssh), active use of
        telnet servers has died off except for some specialized uses.
        One place where telnet lives on is debugging ASCII-based network
        services. For example, web pages can be retrieved by telnetting
        to HTTP servers, and emails can be sent by telnetting to SMTP
        servers. </p>
      <p>Telnetting to a suspected open port is still one of the fastest
        ways to see if a service is available or reachable. </p>
      <p>Here are a few sample uses of telnet: </p>
      <p></p>
      <pre>$ telnet yahoo.com 80<br><br>Trying 66.94.234.13...<br>Connected to yahoo.com.<br>Escape character is '^]'.<br>GET /<br>...<br><br>&lt;html&gt;&lt;head&gt; ...[web page data] ...<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br>Connection closed by foreign host.<br></pre>
      <p> </p>
      <pre>$ telnet mailserver.net 25<br>Trying 216.0.1.1...<br>Connected to mailserver.net.<br><br>Escape character is '^]'.<br>220 mailserver.net ESMTP Postfix (Ubuntu)<br>HELO sender.net<br>250 sender.net<br>MAIL FROM: me@sender.net<br>250 Ok<br>RCPT TO: me@mailserver.net<br>250 Ok<br>DATA<br>354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;<br>Subject: test mail message<br>test message<br>.<br><br>250 Ok: queued as 152CFB8802A<br>^]<br><br>telnet&gt; Connection closed.<br><br>You have mail in /var/mail/me<br></pre>
      For this exercise, you will use <tt>telnet</tt> to test if a TCP
      port is open on a remote host. Telnetnetting to an IP and port
      (see above) should return a "connected" message if it is possible
      to connect to a running server. <span class="anchor" id="nc"></span>
      <h4>netcat: a network swiss army knife</h4>
      <p> netcat (often <tt class="backtick">nc</tt> on some systems)
        is a Unix utility for creating and using TCP and UDP sockets. In
        a very simplified way, <tt class="backtick">netcat</tt> is like
        a telnet client and server without any built in protocol or
        terminal emulation. Another way of putting it is that <tt
          class="backtick">netcat</tt> is the bare essentials for
        creating a TCP or UDP socket and client, with hooks for using
        standard in and standard out for IO. </p>
      <p>There are too many cool uses of netcat to describe here. For
        the purposes of this exercise, we'll use netcat to create "fake"
        TCP or UDP servers that we can use to test firewall
        configurations. </p>
      <h5>Creating fake TCP/UDP servers with netcat</h5>
      <p> Starting a fake listening server (a program that will accept
        connections on a port) is as simple as running: </p>
      <p></p>
      <pre>$ sudo nc -l 80         # we need sudo because 80 is a privileged port<br></pre>
      <p> ... to start a listening TCP socket on port 80. Then, from the
        another host, you can either use telnet or nc to connect to the
        server you just started on the the first host. You should be
        able to type in one window and see output in the other if the
        network pipe is open. </p>
      <p>Testing UDP services is exactly the same -- you can use netcat
        for that, too. You need to start a listening UDP process on the
        receiving side, and a sending process on the sending side. If
        you are testing UDP traffic from a client to a server, you can
        do something like this: </p>
      <p></p>
      <pre>[server]$ nc -u -l 10000        # listen for UDP traffic on port 10000<br></pre>
      <p> Then on the client, do something like this: </p>
      <p></p>
      <pre>[client]$ nc -u server 10000    # connect to server via UDP on port 10000<br></pre>
      <p> After establishing the connection, enter some data from
        standard input (probably your keyboard). Input on the sender
        should appear on the receiving terminal. Hit ^C to close the
        programs. UDP is of course an unreliable network protocol, so
        it's possible that there will be errors in the text file. </p>
      <p>You can do any of this in reverse to test the connection from a
        server to a client. If you're able to transmit data, then the
        firewall is allowing communication. <span class="anchor"
          id="intro"></span> </p>
      <h2>Introduction</h2>
      <p>You are Wilbar Memboob, the Security Administrator of <span
          class="nonexistent">FrobozzCo</span> (<em>"You name it, we
          make it"</em>). You are looking to hire a new system
        administrator to replace the guy you just fired --
        unfortunately, even though his resume looked great on paper and
        he interviewed well, once you put him at a console he clearly
        had no idea what he was doing. </p>
      <p>To him, proper permissions meant that the application worked;
        if it was secure then that was just icing on the cake. You
        should have done something when the other admins starting
        calling him "Triple-7" -- a.k.a. "wide open". But it was when he
        changed the company fileserver directory permissions to
        "ugo+rwx" and the projected budget was "released" early --
        including a list of the employees being laid off -- that he
        signed his own pink slip. </p>
      <p>To keep this from happening again, you've created a little test
        for your new applicants to take. Unfortunately, before you can
        grade the applicants, you need to create an answer key. <span
          class="anchor" id="assignment"></span> </p>
      <h2>Assignment Instructions</h2>
      <p>In the assignment portion of this exercise, you're going to
        create an answer key for your "hiring exam." You'll need to swap
        in your nodes and complete the exercises below. <span
          class="anchor" id="setup"></span></p>
      <div class="level3">
        <h3>Setup</h3>
        <ol type="1">
          <li>
            <p>If you don't have an account, follow the instructions in
              the <a href="DETERintro.html">introduction to DETER</a>
              document. </p>
          </li>
          <li>Log into DETER. </li>
          <li>Create an instance of this exercise by following the
            instructions <a href="DETERintro.html#create">here</a>,
            using <tt>/share/education/PermissionsFirewalls_UCLA/permissions.ns</tt>
            as your NS File. (The permissions.ns file is also made
            available <a href="permissions.ns">here</a> for your
            convenience.)<br>
            <ul>
              <li>
                <p>In the "Idle-Swap" field, enter "1". This tells DETER
                  to swap your experiment out if it is idle for more
                  than one hour. </p>
              </li>
              <li>
                <p>In the "Max. Duration" field, enter "6". This tells
                  DETER to swap the experiment out after six hours. </p>
              </li>
            </ul>
          </li>
          <li> Swap in your new lab. </li>
          <li>After the experiment has finished swapping in, log in to
            the node via ssh. </li>
        </ol>
        <p></p>
        <p>As mentioned in <a href="DETERintro.html">DETER Instructions</a>,
          changes to DETER nodes are lost when the nodes are swapped
          out. This means that you must manually save your work between
          working on nodes in order to keep it. However, <b>this
            exercise</b> includes experimental scripts to help you save
          and restore your work. </p>
        <p><span class="anchor" id="save"></span> </p>
        <p></p>
        <h4>Saving your Work</h4>
        <p>After completing the POSIX and firewall-related execises on
          the <tt>server</tt> node, cd into the <tt>/root</tt>
          directory and execute the script <tt>/root/submit.sh</tt>;
          like this: </p>
        <p></p>
        <pre>$&nbsp;./submit.sh</pre>
        <p>...it will make a tarball of all the relevant files and their
          permissions, including the /root/permissions-answers.txt and
          firewall.sh script you have updated. <strong>You must copy or
            move the created tarball into your group directory,
            otherwise it will be lost upon swapout.</strong> </p>
        <p><span class="anchor" id="restore"></span> </p>
        <p></p>
        <h4>Restoring Your Work</h4>
        <p>The <strong>experimental</strong> script <tt>/root/restore.sh</tt>
          on the <tt>server</tt> node, takes as input the path to a
          tarball created by <tt>submit.sh</tt> described above and
          restores the files to their proper locations on the system.
          This includes all the files you are asked to create or change
          in the first part, as well as the <tt>firewall.sh</tt> script
          for the second part. </p>
        <div class="warning">
          <p><img src="alert.png"> <b>WARNING:</b> These scripts do <strong>not</strong>
            back up all arbitrary changes you may have made to the node
            (e.g., changing a peripheral configuration file), and it
            does not "merge" system files with submission files -- <em>it
              only restores submission files copied by <tt>submit.sh</tt></em>.
            You shouldn't need to change anything else, but see <tt>submit.sh</tt>
            and <tt>restore.sh</tt> to see exactly what those scripts
            do, and do not delete any of your submission tarballs so
            that you can go back to an earlier version if need be. </p>
        </div>
        <p>To use the <tt>restore.sh</tt>, copy a tarball created by <tt>submit.sh</tt>
          into the <tt>/root/</tt> directory and execute this command:
        </p>
        <p></p>
        <pre>$&nbsp;./restore.sh&nbsp;username-permissions-123123123.tar.gz</pre>
        <p>You will be asked if you want to automatically overwrite
          files, and if you want to selectively restore some files and
          not others. The options are self-explanatory. </p>
        <p>Finally, if you don't trust the scripts, you can always make
          your own backups into your group directory and restore them by
          hand if you prefer. </p>
        <div class="warning">
          <p><img src="alert.png"> <strong>NOTE:</strong> You do not
            need to run the submit and restore scripts with sudo.
            However, if you use sudo to run <tt>submit.sh</tt>, your
            tarball will be named after the <tt>root</tt> user. This is
            OK -- just run <tt>sudo&nbsp;./restore.sh&nbsp;root-permissions-2134234243.tar.gz</tt>.
          </p>
        </div>
        <span class="anchor" id="tasks"></span>
        <div class="level3">
          <h3>Tasks</h3>
          <p>Your task is to create an answer key for the following
            test: </p>
          <p></p>
          <h4>FrobozzCo Permissions and Firewall Test</h4>
          <p>This test is a part of the application process for the
            administrator position at <span class="nonexistent">FrobozzCo</span>.
            You will be presented with a number of tasks and questions;
            the tasks must be executed on the <tt>server</tt> node of
            the DETER experiment we have created for this purpose (you
            can use the <tt>client</tt> node for testing), while the
            questions must be answered in a plain text file that will be
            submitted with the results of your tasks. See below for
            further instructions. </p>
          <p></p>
          <h4>Part 1: POSIX File Permissions and 'sudo'</h4>
          <p> </p>
          <h5>Instructions</h5>
          <p>The following section includes a number of permissions,
            firewall, and file creation exercises. This test will be
            performed on a live network testbed with a full complement
            of standard utilities and editors. In addition, you are
            fully encouraged to use the Internet, man pages, help
            screens, and any other resources available to you in the
            execution and answering of these problems. </p>
          <p>Please read and use these <a href="#ambiguity">disambiguation

              rules</a> for setting the correct permissions. Also, make
            sure that you test your answers -- POSIX permissions are
            simple in theory, but in practice many combinations have
            counterintuitive effects! </p>
          <p>Your answers will consist of an archive, created by the <tt>submit.sh</tt>
            script described above. The archive will contain: </p>
          <ol>
            <li>A copy of the necessary server resources containing the
              results of your file creation and permissions
              modifications. You will be graded only on the correctness
              of your answers, not their elegance nor how efficiently
              you came to them.</li>
            <li>Your written answers to the numbered short answer
              questions. These should be written in the file <tt>/root/permissions-answers.txt</tt>
              on the server system using an editor (such as <tt>vim</tt>).</li>
            <li>Your firewall script.</li>
          </ol>
          <p>See below for instructions on <a href="#submitting">submitting</a>
            your answers. </p>
          <p><span class="anchor" id="homedirsec"></span> </p>
          <h5>Home Directory Security</h5>
          <div class="warning">
            <p><img src="alert.png"> <strong>Note:</strong> Admins --
              members of the <tt>wheel</tt> group have <tt>sudo</tt>
              access. However, unless instructed to do so, use only
              standard UNIX ACLs -- don't give user accounts <tt>sudo</tt>
              permissions or consider the <tt>sudo</tt> access the
              'wheel' group already has. Of course, <em>you</em> need
              to use <tt>sudo</tt> to create the accounts, edit root
              files, etc... this is exactly what <tt>sudo</tt> is for.
            </p>
          </div>
          <p>Your server needs two home directories, the usual <tt>/home</tt>
            and also<tt>&nbsp;/admins&nbsp;</tt>for your team. Normal
            home directories are private, while the homedirectories in <tt>&nbsp;/admins&nbsp;</tt>
            will be publicly viewable and somewhat collaborative. </p>
          <ol>
            <li>
              <p>Create the <tt>/admins</tt> directory. </p>
            </li>
            <li>
              <p>Create the group <tt>emp</tt>(see <tt>man groupadd</tt>).

              </p>
            </li>
            <li>
              <p>Create the normal (i.e., non admin) user accounts <tt>larry</tt>,
                <tt>moe</tt>, and <tt>curly</tt>, and the admin user
                accounts <tt>ken</tt>, <tt>dmr</tt>, and <tt>bwk</tt>.
              </p>
              <ul>
                <li>Note that several files from <tt>/etc/skel</tt> are
                  copied into each new homedir. </li>
                <li>Use <tt>passwd</tt> to set their passwords to
                  whatever you like (password security is not important
                  for this test). </li>
              </ul>
            </li>
            <li>
              <p>make sure you specify the home directories for the
                admins as being in <tt>/admins</tt> (see <tt>man&nbsp;adduser</tt>).

              </p>
            </li>
            <li>
              <p>add the non-admin accounts to the <tt>emp</tt> group
                and add the admins to the <tt>wheel</tt> group by
                editing <tt>/etc/group</tt> or using <tt>usermod</tt>.
              </p>
            </li>
            <li>add larry, bwk, and dmr to ken's group. </li>
            <li>add moe, dmr, and ken to bwk's group. </li>
            <li>add curly, ken, and bwk to dmr's group. </li>
            <ul>
              <li>
                <p>Admins are <strong>not</strong> a part of the emp
                  group. </p>
              </li>
            </ul>
            <li>
              <p>The permissions on the home directories already exclude
                prying eyes by default. Set the permission mode on <tt>/home</tt>
                itself so that normal users can't list its contents (but
                can still access their home directories) but so that
                members of the <tt>wheel</tt> group have full access to
                the directory (without using <tt>sudo</tt>). </p>
            </li>
            <li>
              <p>By default, the owner of a homedir is set to be the
                user and the group class of their homedir. Set the
                permission modes recursively on the individual
                homedirectories in <tt>/admins</tt> (see <tt>man chmod</tt>)
                so that: </p>
              <ul>
                <li>
                  <p>owners have <em>full access</em> </p>
                </li>
                <li>group users (users who are in the group associated
                  with a user's home directory) can read and create
                  files in that homedir </li>
                <li>Set it so that any other users can read and execute
                  any files </li>
                <li>Files created by a group member in that homedir
                  should be set to the homedir owner's group. (Hint:
                  Look up what the SUID and SGID bits do on
                  directories.) </li>
                <li>Homedir permissions for the normal users should use
                  the default permissions. </li>
                <li>
                  <p>Example: <tt>larry</tt> is in <tt>ken</tt>'s
                    group. <tt>larry</tt> can create files in ken's
                    homedir, and those files are owned by <tt>larry</tt>,
                    but are assigned to <tt>ken</tt>'s group rather
                    than <tt>larry</tt>'s group. <tt>moe</tt>, not in
                    <tt>ken</tt>'s group, can only read and execute
                    files. </p>
                </li>
              </ul>
            </li>
          </ol>
          <p><span class="anchor" id="ballotbox"></span> </p>
          <h5>The Ballot Box</h5>
          <p>All regular employees use this directory to submit votes
            for "employee of the month". </p>
          <ol>
            <li>
              <p>Create the <tt>/ballots</tt> directory. </p>
            </li>
            <li>
              <p>Set the permissions on <tt>/ballots</tt> so that it is
                owned by root and users can write files into the
                directory but cannot list the contents of the directory.
              </p>
            </li>
            <li>
              <p>Furthermore, set it so that members of the <tt>wheel</tt>
                group have no access (not including sudo). </p>
            </li>
            <li>
              <p><strong>Short Answer 1:</strong> Is there any way that
                employees can read the ballots of other users? If so,
                what could be done to stop this? If not, what prevents
                them from reading them? </p>
            </li>
            <li>
              <p><strong>Short Answer 2:</strong> What does the 'x' bit
                mean when applied to directories? </p>
            </li>
          </ol>
          <p><span class="anchor" id="tpsreports"></span> </p>
          <h5>The TPS Reports Directory</h5>
          <p>Admin employees submit TPS reports in this partially
            collaborative directory. </p>
          <ol>
            <li>
              <p>Create the <tt>/tpsreports</tt> directory. </p>
            </li>
            <li>
              <p>Create the <tt>tps</tt> user. </p>
            </li>
            <li>
              <p>Set the permissions on <tt>/tpsreports</tt> so that it
                is owned by <tt>tps</tt> and that members of the <tt>wheel</tt>
                group have full access to the directory, but so that no
                one else has access to the directory. </p>
            </li>
            <li>
              <p>Furthermore, configure it so that files written into it
                are still owned by the <tt>wheel</tt> group, but so
                that one member of <tt>wheel</tt> cannot delete another
                member's files. </p>
            </li>
            <li>
              <p><strong>Short Answer 3:</strong> Which users on the
                system can delete arbitrary files in the <tt>/tpsreports</tt>
                directory? </p>
            </li>
            <li>
              <p><strong>Short Answer 4:</strong> Is there any way that
                non-<tt>wheel</tt> employees can read files in the <tt>/tpsreports</tt>
                directory? </p>
            </li>
            <li>
              <p><strong>Short Answer 5:</strong> What do '0'
                permissions mean for the owner of a directory? What
                privileges do they have over files in that directory? </p>
            </li>
          </ol>
          <p><span class="anchor" id="sudoprobs"></span> </p>
          <h5>sudo: Editing Configuration Files</h5>
          <div class="infobox">
            <p><img src="idea.png"> <em>For the following three short
                answer questions, assume that your answers are
                unrelated; that is, your answer for question 6 does not
                impact the answer for questions 7 or 8.</em> </p>
          </div>
          <p>All members of the <tt>wheel</tt> group do system
            administration on the server. Because of this, they all have
            full sudo access to <tt>root</tt> privilege with the <tt>/etc/sudoers</tt>
            directive '<tt>%wheel&nbsp;ALL=(ALL)&nbsp;NOPASSWD:&nbsp;ALL</tt>'.
The

            "NOPASSWD" means they don't have to enter a passwd upon sudo
            invocation. </p>
          <p>The employee <tt>larry</tt> is the webmaster for the
            system, so he has some extra privilege compared to the other
            employees. For example, <tt>larry</tt> has <tt>sudo</tt>
            access to the command </p>
          <p><tt>/usr/bin/vim&nbsp;/etc/httpd/conf/httpd.conf&nbsp;</tt>
          </p>
          <p>... with the directive </p>
          <p></p>
          <pre>larry ALL=(ALL) /usr/bin/vim /etc/httpd/confs/httpd.conf</pre>
          <p>... so that he can update the configuration of the
            webserver. </p>
          <p><strong>Short Answer 6:</strong> Is this safe? Why or why
            not? If it is not safe, is there a better way to give <tt>larry</tt>
            this access? If it is safe, how do you <em>know</em> it is
            safe? (Hint: search online for common <tt>sudo</tt>
            issues.) </p>
          <p></p>
          <h5>sudo: Restarting System Processes</h5>
          <p>As a part of his webmaster duties, <tt>larry</tt> often
            requests the <tt>wheel</tt> group to restart the Apache
            server with the command '<tt>/etc/init.d/httpd&nbsp;restart</tt>'.
            It would make everyone very happy if there was a secure way
            to let <tt>larry</tt> restart the Apache server (but not
            give him any other access). </p>
          <p><strong>Short Answer 7: </strong>Assuming the init script
            <tt>/etc/init.d/httpd</tt> has no unknown vulnerabilities,
            is it safe to grant <tt>larry</tt> <tt>sudo</tt> access to
            the command <tt>/etc/init.d/httpd restart</tt>? If this is
            not secure, explain why. </p>
          <p></p>
          <h5>POSIX and sudo: Two Wrongs Make a Much Bigger Wrong</h5>
          <p>Carefully examine the permissions on the server. Look at <tt>/etc/group</tt>,
            <tt>/etc/sudoers</tt>, and the files in the <tt>/admins</tt>
            and <tt>/home</tt> directories (and their subdirectories).
          </p>
          <p><strong>Short Answer 8: </strong>Is there some way that <tt>moe</tt>
            or <tt>curly</tt> could subvert this system to gain <tt>root</tt>
            privileges? If not, how do you know this is true? </p>
          <p><b>Hint:</b> Consider what happens during the UNIX login
            process -- the time between when the user enters the correct
            password and when they can interact with their shell. </p>
          <p><span class="anchor" id="firewall"></span> </p>
          <h4>Part 2: Firewall Configuration</h4>
          <p>The test server has a totally permissive firewall installed
            -- it accepts all inbound and outbound traffic from all
            ports, protocols, addresses, interfaces, and states. This is
            basically like having no firewall at all. </p>
          <p>Your task is to configure the firewall according to the
            principle of "least privilege". This means that it should be
            maximally restrictive while still permissive enough to allow
            a strictly defined set of tasks. While some of these rules
            can <em>also</em> be configured in the server software
            (this strategy is called <a class="http"
              href="http://en.wikipedia.org/wiki/Defense_in_depth_%28computing%29">defense
in

              depth</a>), we want you to implement the rules in iptables
            <strong>only </strong>-- do not reconfigure the underlying
            software. </p>
          <p>The firewall has been copied into the directory <tt>/root/firewall/</tt>
            along with a script called <tt>extingui.sh</tt> to "put out
            the fire" and clear all the rules in case you make a
            mistake. The firewall is <strong>not</strong> enabled by
            default -- to enforce the rules, execute: </p>
          <p></p>
          <pre>/root/firewall/firewall.sh</pre>
          <p>... as the <tt>root</tt> user or using <tt>sudo</tt>: </p>
          <p></p>
          <pre>sudo&nbsp;/root/firewall/firewall.sh</pre>
          <p>This will load the rules and start enforcing them. To make
            sure that you are removing all iptables rules, you should
            run <tt>extingui.sh</tt> in <strong>between every
              invocation of firewall.sh</strong> or rules might "stick
            around" which can be very confusing if you are trying to
            debug the system. This can be done like this as root (or
            with <tt>sudo</tt> as above): </p>
          <p></p>
          <pre>/root/firewall/extingui.sh</pre>
          <p>If you make the server inaccessible with broken rules,
            don't worry -- you can reboot the node in the DETER console,
            and since the firewall <em>is not enabled by default</em>,
            you can log in in order to fix it. Your files will still be
            on the experimental node <strong>as long as you don't swap
              out the experiment</strong>. (Of course, you can
            permanently save your files in your home directory.) </p>
          <p>Finally, only your final product is evaluated -- not the
            number of times you have to reboot the server. You should
            expect to lock yourself out a few times. <img alt=":)"
              src="/wiki/modern/img/smile.png" title=":)" height="15"
              width="15"> </p>
          <p><strong>Here's what the firewall needs to do:</strong> </p>
          <ol>
            <li>
              <p><strong>passively ignore</strong> any traffic inbound
                to the interface that says it's coming from the server
                itself (obvious spoof attempt). </p>
            </li>
            <li>
              <p>The firewall only needs to limit the experimental
                network interface (the interface with the 10.1.x.x
                network). The interface is one of ethN and you can
                determine which one it is for your experimental node
                using the command <tt>ifconfig</tt> -- however note
                that this interface could change with a different
                experimental node. See below for instructions on using
                environment variables to define the experimental
                interface in your firewall.sh script. </p>
            </li>
            <li>
              <p>allow all <em>established</em> inbound and outbound
                traffic on the experimental network interface (the
                interface with the 10.1.x.x network) of all acceptable
                forms, which are described below: </p>
            </li>
            <li>
              <p>allow <strong>new</strong> connections on the
                experimental network (10.1.x.x) of these kinds: </p>
              <ol>
                <li>Inbound TCP connections to the OpenSSH, Apache, and
                  MySQL servers on their standard ports.
                  <ul>
                    <li>
                      <p>The MySQL server should <strong>only</strong>
                        accept connections from the <strong>client</strong>
                        host. </p>
                    </li>
                  </ul>
                </li>
                <li>
                  <p>Inbound UDP connections to the ports 10000 to 10005
                    from the host <strong>client</strong>. </p>
                </li>
                <li>
                  <p>Inbound ICMP <tt>ping</tt> requests and replies. </p>
                </li>
                <li>Outbound TCP connections to any OpenSSH, SMTP, and
                  Apache (on standard ports). </li>
                <li>
                  <p>Outbound UDP connections to the host <strong>client</strong>
                    on ports 10006-10010 </p>
                </li>
                <li>
                  <p>Outbound ICMP <tt>ping</tt> requests and replies.
                  </p>
                </li>
              </ol>
            </li>
            <li>
              <p><strong>passively ignore all other traffic</strong>.
                (Do not allow it or respond to it in any way.) </p>
            </li>
          </ol>
          <p>There are many online resources and tutorials for iptables
            configuration -- feel free to use them. Be aware, however, <strong>not
all

              tutorials emphasize the principle of least privilege</strong>
            and may give you overly permissive advice! In order to
            properly configure the firewall, you must consider the basic
            ways the firewall can differentiate traffic and allow only
            the specific types you require to properly function. </p>
          <p>Please read the helpful advice in the next section for
            configuring and testing your firewall. </p>
        </div>
        <span class="anchor" id="tips"></span>
        <div class="level3">
          <h3>Tips and Tricks</h3>
          This section includes important rules and tips for making sure
          that your answers are correct.
          <p><span class="anchor" id="ambiguity"></span> </p>
          <h4>1. Rules for resolving filesystem permission ambiguities:</h4>
          <p>Permissions should <em>always</em> be set to reflect the <strong>least

              privilege</strong> required to fulfill the requirements.
            In POSIX permissions, every bit set represents <em>less
              security</em>, so we want to set as few bits as possible.
            Resolve any ambiguities with this cumulative list of
            guidelines: </p>
          <ol type="1">
            <li>
              <p>Files you are instructed to create are to be owned by <tt>root</tt>
                unless otherwise specified. Doing the work as <tt>root</tt>
                should do this automatically. (You can become root by
                executing <tt>sudo&nbsp;su&nbsp;-</tt>.) </p>
              <ul>
                <li>Exception: Files in homedirs should be owned by the
                  homedir owner (useradd should do this by default for
                  boilerplate files like .bash_login, etc). </li>
              </ul>
            </li>
            <li>When setting ownership of a file, set the group class to
              the same thing as the user (owner) class unless otherwise
              specified.
              <ul>
                <li>
                  <p>Example: Create the directory <tt>foo</tt>. Set <tt>www-data</tt>
                    as the owner of <tt>foo</tt>. </p>
                </li>
                <li>
                  <p>Answer: Set <tt>www-data</tt> to be the user
                    (owner) and group class of <tt>foo</tt>. </p>
                </li>
                <li>
                  <p>Example: Create the directory <tt>xyzzy</tt>. Set
                    the group class to <tt>www-data</tt>. </p>
                </li>
                <li>
                  <p>Answer: Set the group class to <tt>www-data</tt>
                    but the user class should still be set to <tt>root</tt>.
                  </p>
                </li>
              </ul>
            </li>
            <li>
              <p>Files whose permissions you are <em>not</em> otherwise
                instructed to change should stay at their default. </p>
              <ul>
                <li>
                  <p>Example: Create directory <tt>baz</tt>. Create
                    directory <tt>quux</tt> and set its permissions to
                    be wide open. </p>
                </li>
                <li>
                  <p>Answer: Don't change <tt>baz</tt>'s file mode. It
                    should be owned by root (as per #1). Set <tt>quux</tt>
                    permissions to <tt>0777</tt>. </p>
                </li>
              </ul>
            </li>
            <li>
              <p>For any files whose permissions you <em>are</em>
                instructed to change, unspecified permissions are <strong>always</strong>
                assumed to be 0 (no access). In other words,
                instructions for setting file permissions implicitly
                include all access groups (even those not explicitly
                mentioned). </p>
              <ul>
                <li>
                  <p>Example: Set directory <tt>foo</tt> so that its
                    owner has full access. </p>
                </li>
                <li>
                  <p>Answer: The correct mode is <tt>0700</tt>, since
                    no group or other permissions were specified and we
                    assume that they are 0. </p>
                </li>
              </ul>
            </li>
            <li>Permissions are assumed to be for all classes unless
              specified.
              <ul>
                <li>
                  <p>Example: Remove all permissions from <tt>/dev/hdc</tt>.
                  </p>
                </li>
                <li>
                  <p>Answer: Set <tt>/dev/hdc</tt> to mode <tt>000</tt>
                    (root still has access of course). </p>
                </li>
                <li>
                  <p>Example: Set read and write permissions on <tt>/etc/motd</tt>.
                  </p>
                </li>
                <li>
                  <p>Answer: <tt>/etc/motd</tt> should be set to mode
                    0666 -- all classes can read and write. </p>
                </li>
              </ul>
            </li>
            <li>
              <p>When granting permissions, setuid, setgid, and sticky
                bits are <strong>never</strong> granted unless
                specifically required to solve the problem. These bits
                are special and must be required by the nature of the
                question or be otherwise mentioned to be granted. </p>
              <ul>
                <li>Example: Set a directory so that owner has full
                  access and it's group class members can create files
                  in it. </li>
                <li>
                  <p>Answer: The correct mode is <tt>0730</tt> because
                    a user (in this case the group user) requires both
                    write and execute to create files. The question
                    didn't specify anything requiring setuid or setgid
                    so they are not enabled. </p>
                </li>
                <li>
                  <p>Note: the <tt>other</tt> class in this example has
                    no access because the permission is assumed to be <tt>0</tt>
                    (as per #4). </p>
                </li>
                <li>
                  <p>Note: In #3 above, see that "wide open" for the
                    directory quux meant <tt>0777</tt> <strong>not</strong>
                    <tt>4777</tt> because setuid was not specified or
                    required. </p>
                </li>
              </ul>
            </li>
            <li>If any tasks are not possible with the standard POSIX
              permissions available in this exercise, explain why. </li>
          </ol>
          <p><span class="anchor" id="envvars"></span> </p>
          <h4>2. Use Environment Variables in your firewall.sh!</h4>
          <p>Your firewall script is only supposed to limit the traffic
            on the "experimental network" interface, as opposed to
            including the "control network" of DETER. If you block the
            control network, you're likely to lose connection to your
            node, or shut off networked file systems, etc. </p>
          <p>Unfortunately, different DETER nodes (the physical
            computers you are given) bring up their networks on
            different interfaces (and in general you can't control which
            nodes you get). This means that on one node, the
            experimental network might be on eth0, and on another node,
            it might be on eth4 (or any other ethN). This makes writing
            your script difficult because it is not 100% portable from
            one node to another. </p>
          <p>However, we can use an environment variable to substitute
            in the right interface. In the firewall.sh script, there is
            a variable declaration: </p>
          <p></p>
          <pre>ETH="eth0"<br></pre>
          <p>You can use this variable with the token $ETH -- the shell
            will substitute in its value at runtime. Use ifconfig to
            make sure that ETH is set to the right value for your
            experimental node (or update it). For example, use ETH in a
            hypothetical iptables command like this: </p>
          <p></p>
          <pre>iptables -A INPUT -i $ETH -j ACCEPT<br></pre>
          <p>This way, you only need to update the ETH variable if your
            interface changes, rather than every iptables call that
            specifies an interface. </p>
          <p></p>
          <h4>3. How to test your firewall</h4>
          <p>Testing your firewall is easy; you just need to make all
            the necessary network connections to verify that they work,
            and perhaps some other testing to show that the deny rules
            also work. Telnet isn't good for much anymore, but testing
            network services is one of the few remaning places where it
            shines. </p>
          <p>You may have noticed that this experiment swaps in two
            nodes instead of one. One will be called <tt>client</tt>
            and the other will be called <tt>server</tt>. <tt>server</tt>
            is the node with the firewall and resources you want to
            protect, but you can use client to check to see if the
            firewall is doing its job. You can also use client as a
            target to see if the server's outbound rules are functioning
            properly, using tools such as nmap, telnet, nc, and others
            in the <a href="#nettools">network tools portion of this
              document</a>. </p>
          <p>To test apache, mysql, ssh, and ping on the server, execute
            these commands from client. This does not test full
            correctness -- it only tests to see if you can actually
            access the services required. If you see similar output (as
            opposed to nothing or errors), the services are running. </p>
          <p>Examples: </p>
          <p></p>
          <pre>[client]$ telnet server 80              #testing apache<br><br>Trying 10.1.1.3...<br>Connected to server.<br>Escape character is '^]'.<br>^]                                      #hit control-] to escape<br>telnet&gt; quit<br>Connection closed.<br><br>[client]$ telnet server 3306            #testing mysql<br>Trying 10.1.1.3...<br>Connected to server.           # if you see this, you're connected<br>Escape character is '^]'.<br><br>[possibly some garbage or the server may disconnect you automatically]<br>^]<br>telnet&gt; quit<br><br>Connection closed.<br></pre>
          <div class="warning">
            <p><img src="alert.png"> Note: The MySQL server has its own
              internal permissions system -- so it may not like your
              client, or your IP address -- but if you see "Connected
              to..." or receive messages back from the MySQL server
              (even if the messages say "access denied" -- you are able
              to contact the server. iptables/netfilter does not send
              error messages to clients! </p>
          </div>
          <p> </p>
          <pre>[client]$ telnet server 22              #testing ssh<br>Trying 10.1.1.3...<br>Connected to server.<br>Escape character is '^]'.<br>SSH-1.99-OpenSSH_4.2<br>^]<br><br>telnet&gt; quit<br>Connection closed.<br></pre>
          <p>Testing ping is dead simple: </p>
          <p></p>
          <pre>[client]$ ping server<br>PING server-link0 (10.1.1.3) 56(84) bytes of data.<br>64 bytes from server-link0 (10.1.1.3): icmp_seq=0 ttl=64 time=1.14 ms<br>^C<br>--- server-link0 ping statistics ---<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min/avg/max/mdev = 1.140/1.140/1.140/0.000 ms, pipe 2<br>[client]$<br></pre>
          <p>Of course, to test that in the other direction, just do <tt>ping&nbsp;client</tt>
            from the server. </p>
          <p>Testing outbound services from the server is a bit harder,
            because DETER is a secure testbed and won't let you actually
            get out to the Internet. But we can fake some services
            running on the client to test. See our discussion of netcat
            for more information. </p>
        </div>
        <span class="anchor" id="glitches"></span>
        <div class="level3">
          <h3>What can go wrong</h3>
          <h4>1. Your firewall cuts off your access to the node.</h4>
          <p>If you have misconfigured your firewall, and it "locks you
            out," you can try to reboot your experimental nodes using
            the DETER interface. If that does not work, you will need to
            swap your nodes out and back in again, but beware that
            swapping your nodes out will destroy any work you have not
            backed up in your home directory. </p>
          <p>Make sure you are using the environment variable to define
            the interface you are restricting -- this will help keep you
            from getting "locked out." See the <a href="#tips">tips and
              tricks</a> section for more information. </p>
        </div>
        <!-- <span class="anchor" id="extra"></span> 
<h2>Extra Credit</h2>

This section describes any extra credit assignments, how to do them, what to measure, etc. If there are no extra credit assignments for this exercise remove this section from here and from the TOC.

--><span class="anchor" id="submission"></span>
        <h2>Submission Instructions</h2>
        <p>Submit a tarball created by <a href="submit.sh"><tt>submit.sh</tt></a>
          to your instructor. You <strong>must</strong> use a tarball
          created by <a href="submit.sh">this script</a> so that it
          will correctly save the permissions of the directories. </p>
      </div>
    </div>
  </body>
</html>
